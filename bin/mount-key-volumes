#!/bin/bash -eu
#
# Loads a key volume from $HOME/Dropbox/Vaults/Keys.dmg

KEY_VOLUME=${KEY_VOLUME:-"$HOME/Library/Mobile Documents/com~apple~CloudDocs/Keys.dmg"}

if [ ! -f "$KEY_VOLUME" ] ; then
  echo "$KEY_VOLUME doesn't exist"
  exit 1
fi

volume=$(hdiutil attach "$KEY_VOLUME" | grep Volumes | awk '{print $2}')

if [[ -d "$HOME/.ssh" && ! -L "$HOME/.ssh" ]] ; then
  mv $HOME/.ssh $HOME/.ssh-backup
fi

echo "Linking $volume/ssh $HOME/.ssh"
ln -fs $volume/ssh $HOME/.ssh

echo "Linking $volume/aws $HOME/.aws"
ln -fs $volume/aws $HOME/.aws

echo "Linking $volume/gnupg $HOME/.gnupg"
ln -fs $volume/gnupg $HOME/.gnupg

echo "Linking $volume/netrc $HOME/.netrc"
ln -fs $volume/netrc $HOME/.netrc

echo "Linking $volume/git/identities $HOME/.gitidentities"
ln -fs $volume/git/identities $HOME/.gitidentities
